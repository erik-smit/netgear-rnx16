        # .compatible     = "rnx16",
        # .gpio_label     = "gpio_ich",
        # .oled_sdin      = 54,
        # .oled_sclk      = 52,
        # .oled_dc        = 32,
        # .oled_cs        = 50,
        # .oled_ctrl      = 6,
        # .oled_reset     = 7,

import gpiod
import math
import time

chip = gpiod.Chip('gpiochip0')

gpios = {
    "sdin": chip.get_line(54),
    "sclk": chip.get_line(52),
    "dc": chip.get_line(32),
    "cs": chip.get_line(50),
    "ctrl": chip.get_line(6),
    "reset": chip.get_line(7),
}

OLED_X_OFFSET = 4
OLED_COLS = 16
OLED_ROWS = 2

oled_row = 0
oled_col = 0

for _name, gpio in gpios.items():
    gpio.request(consumer="erik", type=gpiod.LINE_REQ_DIR_OUT)

def spi_send(c, cmd: bool):
    # print(f'0x{c:02x}')
    gpios["cs"].set_value(0)
    gpios["dc"].set_value(0 if cmd else 1)

    for bit in [7,6,5,4,3,2,1,0]:
        mask = 2**bit
        gpios["sclk"].set_value(0)
        gpios["sdin"].set_value(1 if (c & 2**bit) else 0)
        gpios["sclk"].set_value(1)

    gpios["cs"].set_value(1)
    gpios["dc"].set_value(1)

def spi_send_data(d):
    spi_send(d, False)

def spi_send_cmd(c):
    spi_send(c, True)

def clear_oled(sleepy: bool = False):
    spi_send_cmd(0x40) # Start position

    for page in range(0,4):
        gpios["cs"].set_value(0)
        gpios["dc"].set_value(0)
        spi_send_cmd(SSD1306_B0_SET_PAGE_START + page)
        spi_send_cmd(0x10)
        spi_send_cmd(OLED_X_OFFSET)
        gpios["dc"].set_value(1)

        for col in range(0,128):
            spi_send_data(0x0)

    oled_return_home()

def oled_return_home():
    oled_set_cursor_pos(0,0)

def oled_set_cursor_pos(row, col):
    global oled_row
    global oled_col
    oled_row = min(row, 1)
    oled_col = min(col, OLED_COLS)

font = {
    ' ': [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    '!': [0x00,0x00,0x00,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x33,0x30,0x00,0x00,0x00],
    '"': [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    '#': [0x40,0xc0,0x78,0x40,0xc0,0x78,0x40,0x00,0x04,0x3f,0x04,0x04,0x3f,0x04,0x04,0x00],
    '$': [0x00,0x70,0x88,0xfc,0x08,0x30,0x00,0x00,0x00,0x18,0x20,0xff,0x21,0x1e,0x00,0x00],
    '%': [0xf0,0x08,0xf0,0x00,0xe0,0x18,0x00,0x00,0x00,0x21,0x1c,0x03,0x1e,0x21,0x1e,0x00],
    '&': [0x00,0xf0,0x08,0x88,0x70,0x00,0x00,0x00,0x1e,0x21,0x23,0x24,0x19,0x27,0x21,0x10],
    "'": [0x10,0x16,0x0e,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    '(': [0x00,0x00,0x00,0xe0,0x18,0x04,0x02,0x00,0x00,0x00,0x00,0x07,0x18,0x20,0x40,0x00],
    ')': [0x00,0x02,0x04,0x18,0xe0,0x00,0x00,0x00,0x00,0x40,0x20,0x18,0x07,0x00,0x00,0x00],
    '*': [0x40,0x40,0x80,0xf0,0x80,0x40,0x40,0x00,0x02,0x02,0x01,0x0f,0x01,0x02,0x02,0x00],
    '+': [0x00,0x00,0x00,0xf0,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x1f,0x01,0x01,0x01,0x00],
    ',': [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x16,0x0e],
    '-': [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x00,0x00],
    '.': [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00,0x00,0x00],
    '/': [0x00,0x00,0x00,0x00,0x80,0x60,0x18,0x04,0x00,0x60,0x18,0x06,0x01,0x00,0x00,0x00],
    '0': [0xe0,0x18,0x04,0x04,0x04,0x18,0xe0,0x00,0x07,0x18,0x20,0x20,0x20,0x18,0x07,0x00],
    '1': [0x00,0x10,0x08,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,0x00,0x00,0x00,0x00],
    '2': [0x00,0x08,0x04,0x04,0x88,0x70,0x00,0x00,0x00,0x30,0x28,0x26,0x21,0x20,0x00,0x00],
    '3': [0x00,0x08,0x84,0x84,0x48,0x38,0x00,0x00,0x00,0x10,0x20,0x20,0x11,0x0e,0x00,0x00],
    '4': [0x00,0x80,0x60,0x18,0xfc,0x00,0x00,0x00,0x06,0x05,0x04,0x04,0x3f,0x04,0x00,0x00],
    '5': [0x00,0xfc,0x84,0x84,0x04,0x00,0x00,0x00,0x00,0x10,0x20,0x20,0x11,0x0e,0x00,0x00],
    '6': [0x00,0xe0,0x98,0x44,0x44,0x84,0x08,0x00,0x00,0x07,0x19,0x20,0x20,0x10,0x0f,0x00],
    '7': [0x00,0x04,0x04,0x04,0xc4,0x3c,0x00,0x00,0x00,0x00,0x30,0x0e,0x01,0x00,0x00,0x00],
    '8': [0x30,0x48,0x84,0x84,0x84,0x48,0x30,0x00,0x0e,0x11,0x20,0x20,0x20,0x11,0x0e,0x00],
    '9': [0xf0,0x08,0x04,0x04,0x98,0xe0,0x00,0x00,0x10,0x21,0x22,0x22,0x19,0x07,0x00,0x00],
    ':': [0x00,0x00,0x00,0xc0,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x00],
    ';': [0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x60,0x00,0x00,0x00,0x00],
    '<': [0x00,0x00,0x80,0x40,0x20,0x10,0x08,0x00,0x00,0x01,0x02,0x04,0x08,0x10,0x20,0x00],
    '=': [0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x00,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x00],
    '>': [0x00,0x08,0x10,0x20,0x40,0x80,0x00,0x00,0x00,0x20,0x10,0x08,0x04,0x02,0x01,0x00],
    '?': [0x00,0x70,0x48,0x08,0x08,0x08,0xf0,0x00,0x00,0x00,0x00,0x30,0x36,0x01,0x00,0x00],
    '@': [0xc0,0x30,0xc8,0x28,0xe8,0x10,0xe0,0x00,0x07,0x18,0x27,0x24,0x23,0x14,0x0b,0x00],
    'A': [0x00,0x00,0xf0,0x0c,0xf0,0x00,0x00,0x00,0x30,0x0f,0x04,0x04,0x04,0x0f,0x30,0x00],
    'B': [0x00,0xfc,0x04,0x04,0xd8,0x20,0x00,0x00,0x00,0x3f,0x21,0x21,0x12,0x0e,0x00,0x00],
    'C': [0xe0,0x10,0x08,0x04,0x04,0x04,0x08,0x00,0x07,0x08,0x10,0x20,0x20,0x20,0x10,0x00],
    'D': [0xfc,0x04,0x04,0x04,0x08,0x10,0xe0,0x00,0x3f,0x20,0x20,0x20,0x10,0x08,0x07,0x00],
    'E': [0xfc,0x84,0x84,0x84,0x04,0x00,0x00,0x00,0x3f,0x20,0x20,0x20,0x20,0x00,0x00,0x00],
    'F': [0xfc,0x84,0x84,0x84,0x84,0x04,0x00,0x00,0x3f,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    'G': [0xe0,0x18,0x04,0x04,0x04,0x08,0x00,0x00,0x07,0x18,0x20,0x20,0x21,0x1f,0x00,0x00],
    'H': [0xfc,0x80,0x80,0x80,0x80,0x80,0xfc,0x00,0x3f,0x00,0x00,0x00,0x00,0x00,0x3f,0x00],
    'I': [0x00,0x00,0x00,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,0x00,0x00,0x00,0x00],
    'J': [0x00,0x00,0x00,0x00,0xfc,0x00,0x00,0x00,0x00,0x20,0x20,0x20,0x1f,0x00,0x00,0x00],
    'K': [0xfc,0x80,0x40,0x20,0x10,0x08,0x04,0x00,0x3f,0x01,0x02,0x04,0x08,0x10,0x20,0x00],
    'L': [0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,0x20,0x20,0x20,0x20,0x20,0x00,0x00],
    'M': [0xfc,0x78,0x80,0x00,0xc0,0x38,0xfc,0x00,0x3f,0x00,0x07,0x38,0x07,0x00,0x3f,0x00],
    'N': [0xfc,0x18,0xe0,0x00,0x00,0xfc,0x00,0x00,0x3f,0x00,0x00,0x07,0x18,0x3f,0x00,0x00],
    'O': [0xe0,0x18,0x04,0x04,0x04,0x18,0xe0,0x00,0x07,0x18,0x20,0x20,0x20,0x18,0x07,0x00],
    'P': [0x00,0xfc,0x04,0x04,0x88,0x70,0x00,0x00,0x00,0x3f,0x01,0x01,0x00,0x00,0x00,0x00],
    'Q': [0xe0,0x18,0x04,0x04,0x04,0x18,0xe0,0x00,0x03,0x0c,0x10,0x30,0x50,0x4c,0x43,0x00],
    'R': [0x00,0xfc,0x04,0x04,0x88,0x70,0x00,0x00,0x00,0x3f,0x01,0x01,0x06,0x18,0x20,0x00],
    'S': [0x00,0x38,0x44,0x84,0x04,0x08,0x00,0x00,0x00,0x10,0x20,0x20,0x11,0x0e,0x00,0x00],
    'T': [0x04,0x04,0xfc,0x04,0x04,0x04,0x00,0x00,0x00,0x00,0x3f,0x00,0x00,0x00,0x00,0x00],
    'U': [0xfc,0x00,0x00,0x00,0x00,0x00,0xfc,0x00,0x0f,0x10,0x20,0x20,0x20,0x10,0x0f,0x00],
    'V': [0x0c,0xf0,0x00,0x00,0x00,0xe0,0x1c,0x00,0x00,0x00,0x0f,0x30,0x1e,0x01,0x00,0x00],
    'W': [0xfc,0x00,0xf0,0x3c,0xc0,0x00,0xfc,0x00,0x03,0x3c,0x07,0x00,0x0f,0x3f,0x00,0x00],
    'X': [0x00,0x1c,0x60,0xc0,0x30,0x0c,0x00,0x00,0x20,0x18,0x07,0x01,0x06,0x38,0x00,0x00],
    'Y': [0x04,0x18,0xe0,0x00,0xe0,0x18,0x04,0x00,0x00,0x00,0x00,0x3f,0x00,0x00,0x00,0x00],
    'Z': [0x00,0x04,0x04,0xc4,0x34,0x0c,0x00,0x00,0x00,0x38,0x26,0x21,0x20,0x20,0x00,0x00],
    '[': [0x00,0x00,0x00,0xfe,0x02,0x02,0x02,0x00,0x00,0x00,0x00,0x7f,0x40,0x40,0x40,0x00],
    "\\": [0x00,0x0c,0x30,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x06,0x38,0xc0,0x00],
    ']': [0x00,0x02,0x02,0x02,0xfe,0x00,0x00,0x00,0x00,0x40,0x40,0x40,0x7f,0x00,0x00,0x00],
    '^': [0x00,0x00,0x04,0x02,0x02,0x02,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    '_': [0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80],
    '`': [0x00,0x02,0x02,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00],
    'a': [0x00,0x00,0x40,0x40,0x40,0x80,0x00,0x00,0x00,0x1c,0x24,0x22,0x22,0x3f,0x00,0x00],
    'b': [0x00,0xfc,0x40,0x40,0x80,0x00,0x00,0x00,0x00,0x1f,0x20,0x20,0x10,0x0f,0x00,0x00],
    'c': [0x00,0x80,0x40,0x40,0x40,0x80,0x00,0x00,0x0f,0x10,0x20,0x20,0x20,0x10,0x00,0x00],
    'd': [0x00,0x80,0x40,0x40,0x40,0xfc,0x00,0x00,0x0f,0x10,0x20,0x20,0x20,0x3f,0x00,0x00],
    'e': [0x00,0x80,0x40,0x40,0x80,0x00,0x00,0x00,0x0f,0x12,0x22,0x22,0x22,0x13,0x00,0x00],
    'f': [0x00,0x40,0xf8,0x44,0x44,0x04,0x00,0x00,0x00,0x00,0x3f,0x00,0x00,0x00,0x00,0x00],
    'g': [0x00,0xc0,0x20,0x10,0x10,0xe0,0x00,0x00,0x00,0x13,0x24,0x24,0x24,0x1f,0x00,0x00],
    'h': [0xfc,0x80,0x40,0x40,0x40,0x80,0x00,0x00,0x3f,0x00,0x00,0x00,0x00,0x3f,0x00,0x00],
    'i': [0x00,0x00,0x00,0xc8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,0x00,0x00,0x00,0x00],
    'j': [0x00,0x00,0x00,0xd0,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x7f,0x00,0x00,0x00,0x00],
    'k': [0xfc,0x00,0x00,0x80,0x40,0x00,0x00,0x00,0x3f,0x02,0x0d,0x10,0x20,0x00,0x00,0x00],
    'l': [0x00,0x00,0x00,0xfc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,0x00,0x00,0x00,0x00],
    'm': [0xc0,0x40,0x40,0x80,0x40,0x40,0x80,0x00,0x3f,0x00,0x00,0x3f,0x00,0x00,0x3f,0x00],
    'n': [0x00,0xc0,0x40,0x40,0x40,0x80,0x00,0x00,0x00,0x3f,0x00,0x00,0x00,0x3f,0x00,0x00],
    'o': [0x00,0x80,0x40,0x40,0x80,0x00,0x00,0x00,0x0f,0x10,0x20,0x20,0x10,0x0f,0x00,0x00],
    'p': [0xc0,0x40,0x40,0x40,0x80,0x00,0x00,0x00,0xff,0x10,0x10,0x10,0x08,0x07,0x00,0x00],
    'q': [0x00,0x80,0x40,0x40,0x40,0x80,0x00,0x00,0x07,0x08,0x10,0x10,0x10,0xff,0x00,0x00],
    'r': [0x00,0xc0,0x80,0x40,0x40,0x40,0x00,0x00,0x00,0x3f,0x00,0x00,0x00,0x00,0x00,0x00],
    's': [0xc0,0x20,0x20,0x20,0x40,0x00,0x00,0x00,0x10,0x21,0x22,0x22,0x1c,0x00,0x00,0x00],
    # 't': [0xff,0x40,0xf0,0x40,0x40,0x40,0x00,0x00,0x00,0x00,0x1f,0x20,0x20,0x20,0x00,0x00],
    't': [0x00,0x40,0xf0,0x40,0x40,0x40,0x00,0x00,0x00,0x00,0x1f,0x20,0x20,0x20,0x00,0x00],
    'u': [0xc0,0x00,0x00,0x00,0x00,0x00,0xc0,0x00,0x0f,0x10,0x20,0x20,0x20,0x10,0x3f,0x00],
    'v': [0xc0,0x00,0x00,0x00,0x80,0x40,0x00,0x00,0x00,0x0f,0x30,0x1c,0x03,0x00,0x00,0x00],
    'w': [0xc0,0x00,0x00,0xc0,0x80,0x00,0xc0,0x00,0x00,0x1f,0x3e,0x01,0x0f,0x30,0x0f,0x00],
    'x': [0x00,0xc0,0x00,0x00,0x80,0x40,0x00,0x00,0x20,0x10,0x0d,0x06,0x19,0x20,0x00,0x00],
    'y': [0xc0,0x00,0x00,0x00,0x00,0xc0,0x40,0x00,0x80,0x87,0x68,0x18,0x07,0x00,0x00,0x00],
    'z': [0x00,0x40,0x40,0x40,0x40,0xc0,0x00,0x00,0x00,0x30,0x28,0x26,0x21,0x20,0x00,0x00],
    '{': [0x00,0x00,0x00,0x00,0x80,0x7c,0x02,0x02,0x00,0x00,0x00,0x00,0x00,0x3f,0x40,0x40],
    '|': [0x00,0x00,0x00,0x00,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0x00,0x00,0x00],
    '}': [0x00,0x02,0x02,0x7c,0x80,0x00,0x00,0x00,0x00,0x40,0x40,0x3f,0x00,0x00,0x00,0x00],
    '~': [0x00,0x06,0x01,0x01,0x02,0x02,0x04,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]
}

def oled_data_write(c):
    global oled_row
    global oled_col

    cg = font[c]
    xpix = oled_col * 8 + OLED_X_OFFSET
    page = 0

    spi_send_cmd(SSD1306_A6_NORMAL_DISPLAY)
    spi_send_cmd(SSD1306_40_SET_START_LINE) # Start line

    # line1: page 0,1  line 2: page 2,3
    # one char takes 2 page 16 pbits height
    for page in [0,1]:
        gpios["cs"].set_value(0)
        gpios["dc"].set_value(0)

        spi_send_cmd(SSD1306_B0_SET_PAGE_START + oled_row * 2 + page)
        spi_send_cmd((xpix >> 4) | SSD1306_10_SET_HIGHER_COLUMN)
        spi_send_cmd( xpix & 0xf)

        gpios["dc"].set_value(1)

        for i in range(0, 8):
            raster = cg[page * 8 + i]
            # if (ord(c) != 0xff and (ord(c) & 0x80)):
            #     raster ^= ~0
            spi_send_data(raster)

    oled_shift_cursor(True)

def oled_shift_cursor(right: bool):
    global oled_row
    global oled_col

    if right:
        if (oled_col < OLED_COLS and oled_row < OLED_ROWS):
            oled_col += 1
            oled_row += math.floor(oled_col / OLED_COLS)
            oled_col %= OLED_COLS
    else:
        if (oled_col > 0):
            oled_col -= 1
        elif (oled_row > 0):
            oled_col = OLED_COLS - 1
            oled_row = 0


SSD1306_00_COMMAND = 0x00
SSD1306_C0_DATA = 0xC0
SSD1306_40_DATA_CONTINUE = 0x40

SSD1306_81_SET_CONTRAST_CONTROL = 0x81
SSD1306_A4_DISPLAY_ALL_ON_RESUME = 0xA4
SSD1306_A5_DISPLAY_ALL_ON = 0xA5
SSD1306_A6_NORMAL_DISPLAY = 0xA6
SSD1306_A7_INVERT_DISPLAY = 0xA7
SSD1306_AE_DISPLAY_OFF = 0xAE
SSD1306_AF_DISPLAY_ON = 0xAF
SSD1306_E3_NOP = 0xE3
SSD1306_26_HORIZONTAL_SCROLL_RIGHT = 0x26
SSD1306_27_HORIZONTAL_SCROLL_LEFT = 0x27
SSD1306_29_HORIZONTAL_SCROLL_VERTICAL_AND_RIGHT = 0x29
SSD1306_2A_HORIZONTAL_SCROLL_VERTICAL_AND_LEFT = 0x2A
SSD1306_2E_DEACTIVATE_SCROLL = 0x2E
SSD1306_2F_ACTIVATE_SCROLL = 0x2F
SSD1306_A3_SET_VERTICAL_SCROLL_AREA = 0xA3
SSD1306_00_SET_LOWER_COLUMN = 0x00
SSD1306_10_SET_HIGHER_COLUMN = 0x10
SSD1306_20_MEMORY_ADDR_MODE = 0x20
SSD1306_21_SET_COLUMN_ADDR = 0x21
SSD1306_22_SET_PAGE_ADDR = 0x22
SSD1306_40_SET_START_LINE = 0x40
SSD1306_A0_SET_SEGMENT_REMAP = 0xA0
SSD1306_A8_SET_MULTIPLEX_RATIO = 0xA8
SSD1306_B0_SET_PAGE_START = 0xB0
SSD1306_C0_COM_SCAN_DIR_INC = 0xC0
SSD1306_C8_COM_SCAN_DIR_DEC = 0xC8
SSD1306_D3_SET_DISPLAY_OFFSET = 0xD3
SSD1306_DA_SET_COM_PINS = 0xDA
SSD1306_8D_CHARGE_PUMP = 0x8D
SSD1306_D5_SET_DISPLAY_CLOCK_DIV_RATIO = 0xD5
SSD1306_D9_SET_PRECHARGE_PERIOD = 0xD9
SSD1306_DB_SET_VCOM_DESELECT = 0xDB


def init_oled():
    oled_init_cmd = [
                SSD1306_AE_DISPLAY_OFF,   # Turn off display. */
                SSD1306_D5_SET_DISPLAY_CLOCK_DIV_RATIO,   # Display ClocDivide Ratio/Oscillator Frequency */
                0x71,   # to 105Hz. */
                SSD1306_A8_SET_MULTIPLEX_RATIO,   # Multiplex Ratio */
                0x1f,   # to 32mux. */
                SSD1306_D9_SET_PRECHARGE_PERIOD,   # Precharge period. */
                SSD1306_20_MEMORY_ADDR_MODE,   # Memory addressing mode. */
                0xa1,   # Seg re-map 127->0. */
                SSD1306_C8_COM_SCAN_DIR_DEC,   # COM scan direction COM(N-1)-->COM0. */
                SSD1306_DA_SET_COM_PINS,   # COM pins hardware configuration. */
                0xd8,   # Color_mode_set */
                0x00,   # to monochrome mode & normal power mode. */
                SSD1306_81_SET_CONTRAST_CONTROL,   # Contrast control. */
                SSD1306_B0_SET_PAGE_START,   # Page start address for page Addressing mode. */
                SSD1306_D3_SET_DISPLAY_OFFSET,   # Display offset. */
                0x00,
                SSD1306_21_SET_COLUMN_ADDR,   # Column address. */
                OLED_X_OFFSET,          # Colum address start. */
                0x7f+OLED_X_OFFSET,     # Colum address end. */
                SSD1306_22_SET_PAGE_ADDR,   # Page address. */
                0x00,   # Page address start. */
                0x03,   # Page address end. */
                SSD1306_10_SET_HIGHER_COLUMN,   # Higher column start addr for page addressing mode. */
                SSD1306_00_SET_LOWER_COLUMN,   # Lower column start addr for page addressing mode. */
                SSD1306_40_SET_START_LINE,   # Display start line */
                SSD1306_A6_NORMAL_DISPLAY,   # Normal (non-inverted). */
                SSD1306_A4_DISPLAY_ALL_ON_RESUME,   # Entire display Off. */
                SSD1306_DB_SET_VCOM_DESELECT,   # VCOMH Level */
                0x18,   # to 0.83*VCC 0x3c, change from 0x20 to 0x18 avoid power peek issue. */        
    ]

    gpios["reset"].set_value(0)
    time.sleep(0.1) # L pulse > 3us
    gpios["reset"].set_value(1)
    time.sleep(0.1)

    for cmd in oled_init_cmd:
        spi_send_cmd(cmd)

    clear_oled()
    gpios["ctrl"].set_value(1)

    oled_backlight_on(True)

def cont_vert_scroll():
    oled_scroll_cmd = [
        SSD1306_29_HORIZONTAL_SCROLL_VERTICAL_AND_RIGHT,
        0x00, # dummy
        0x00, # start page
        0x00, # time interval
        0x01, # page f end

        0x01, # vertical scrolling
#        0xff,
        SSD1306_2F_ACTIVATE_SCROLL
    ]

    for cmd in oled_scroll_cmd:
        spi_send_cmd(cmd)

def horizontal_scroll():
    oled_scroll_cmd = [
        SSD1306_26_HORIZONTAL_SCROLL_RIGHT,
        0x00, # dummy
        0x00, # start page
        0x06, # time interval
        0x07, # page end
        0x00, # dummy
        0xff, # dummy
        SSD1306_2F_ACTIVATE_SCROLL
    ]

    for cmd in oled_scroll_cmd:
        spi_send_cmd(cmd)

def reset_oled():
    gpios["reset"].set_value(0)
    time.sleep(0.1) # L pulse > 3us
    gpios["reset"].set_value(1)
    time.sleep(0.1)

def oled_backlight_on(on: bool):
    spi_send_cmd(0xaf if on else 0xae)
